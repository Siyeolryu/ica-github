# 레이더 차트 및 가격 비교 차트 AI 분석 기능 추가

**작업일**: 2026-01-21
**작업자**: Backend Developer Agent
**저장소**: ica-github (Submodule)

---

## 작업 개요

레이더 차트와 가격 비교 차트에 특화된 AI 분석 기능을 개발하여 사용자에게 의미 있는 인사이트를 제공합니다. 기존의 범용 차트 분석을 대체하여, 각 차트 유형에 최적화된 분석을 수행하며, AI API 실패 시에도 데이터 기반 폴백 분석을 제공하여 항상 유효한 결과를 반환합니다.

---

## 주요 작업 내용

### 1. 변경된 파일

**파일**: `ica-github/dev2-2Hour/dev2-main/ui_integration/chart_analyzer.py`

#### 1.1. 레이더 차트 AI 분석 (`analyze_radar_chart`)

레이더 차트의 5가지 지표를 기반으로 제품을 종합 분석합니다.

**분석 지표:**
- 신뢰도 (Trust Score): AI 계산 종합 신뢰도 (0-100)
- 재구매율 (Reorder Rate): 재구매 의사 리뷰 비율 (%)
- 한달사용 (One Month Use): 1개월+ 사용 리뷰 비율 (%)
- 평균평점 (Avg Rating): 평균 평점 100점 환산 (0-100)
- 리뷰다양성 (Review Diversity): 리뷰어 다양성 점수 (0-100)

**분석 내용:**
- 제품별 강점/약점 식별
- 제품 간 비교 인사이트
- 균형형 vs 특화형 제품 분류
- 사용자 유형별 추천 (가성비 중시, 품질 중시, 신뢰도 중시)
- 최고 추천 제품 선정 및 이유

**출력 형식:**
```python
{
    "summary": "핵심 요약 (3-4문장)",
    "key_findings": ["발견사항1", "발견사항2", "발견사항3"],
    "trends": "전체 트렌드 분석",
    "insights": "실용적 인사이트 및 추천",
    "data_quality": "데이터 신뢰도 평가",
    "best_product": "최고 제품명과 이유"
}
```

#### 1.2. 가격 비교 차트 AI 분석 (`analyze_price_comparison`)

가격과 신뢰도를 기반으로 가성비 분석을 수행합니다.

**분석 메트릭:**
- 가격 (Price)
- 신뢰도 (Trust Score)
- 가성비 지수 (Value Score = Trust Score / Price)

**분석 내용:**
- 가격 대비 신뢰도 효율성 분석
- 프리미엄 제품 vs 가성비 제품 분류
- 가격대별 추천
- 최적의 가치 제품 선정
- 가격-신뢰도 상관관계 분석

**출력 형식:**
```python
{
    "summary": "핵심 요약",
    "key_findings": ["최저가 제품", "최고가 제품", "최고 가성비 제품"],
    "trends": "가격-신뢰도 상관관계",
    "insights": "예산별 구매 추천",
    "data_quality": "데이터 신뢰도",
    "best_value": "최고 가성비 제품명과 이유"
}
```

#### 1.3. 에러 처리 개선

**Before (기존 코드):**
```python
except Exception as e:
    return {
        "error": str(e),
        "summary": "분석 중 오류가 발생했습니다.",
        "key_findings": [],
        "trends": "분석 불가",
        "insights": "데이터를 다시 확인해주세요.",
        "data_quality": "불명"
    }
```

**After (개선된 코드):**
```python
except Exception as e:
    # AI 호출 실패 시에도 데이터 기반 폴백 분석 제공
    return self._create_fallback_radar_analysis(radar_metrics)
```

**개선 효과:**
- 에러 메시지 대신 데이터 기반 통계 분석 제공
- 항상 의미 있는 인사이트 반환
- 사용자 경험 향상 (에러 상황에서도 유용한 정보 제공)

#### 1.4. 추가된 Helper Methods

| 메서드 | 기능 |
|--------|------|
| `_parse_json_response()` | AI 응답 JSON 파싱 및 필수 필드 검증 |
| `_create_default_response()` | 기본 응답 구조 생성 |
| `_generate_fallback_summary()` | 레이더 차트 폴백 요약 생성 |
| `_generate_price_fallback_summary()` | 가격 비교 폴백 요약 생성 |
| `_create_fallback_radar_analysis()` | AI 실패 시 레이더 차트 분석 |
| `_create_fallback_price_analysis()` | AI 실패 시 가격 비교 분석 |
| `_generate_generic_summary()` | 범용 요약 생성 |
| `_create_generic_fallback_analysis()` | 범용 폴백 분석 생성 |

---

## 기술 스택

- **Language**: Python 3.12
- **AI Model**: Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
- **API**: Anthropic API
- **Data Processing**: JSON, pandas (간접 사용)
- **Visualization**: Streamlit + Plotly (연동)

**의존성 변경 사항**: 없음 (기존 라이브러리 사용)

---

## 트러블슈팅

### 문제 1: AI 분석 실패 시 사용자에게 에러 메시지만 표시

**증상:**
- AI API 호출 실패 시 "분석 중 오류가 발생했습니다" 메시지만 표시
- 데이터가 있음에도 불구하고 유용한 정보 제공 불가

**해결 방법:**
- 모든 분석 함수에 폴백 로직 추가
- AI 실패 시 데이터 기반 통계 분석 수행
- 평균, 최대/최소값, 순위 등 계산하여 의미 있는 인사이트 생성

**코드 예시:**
```python
def _create_fallback_radar_analysis(self, radar_metrics: List[Dict]) -> Dict[str, Any]:
    # 통계 계산
    avg_trust = sum(m["trust_score"] for m in radar_metrics) / len(radar_metrics)
    best_product = max(radar_metrics, key=lambda x: x["trust_score"])

    return {
        "summary": f"{len(radar_metrics)}개 제품 분석. 평균 신뢰도 {avg_trust:.1f}점...",
        "key_findings": [
            f"최고 제품: {best_product['name']} (신뢰도 {best_product['trust_score']:.1f}점)",
            # ...
        ],
        # ...
    }
```

### 문제 2: 차트별 특화 분석 부족

**증상:**
- 모든 차트에 동일한 범용 분석 적용
- 레이더 차트의 5가지 지표 특성 미반영
- 가격 비교 차트의 가성비 개념 부재

**해결 방법:**
- 차트 타입별 전용 분석 함수 구현 (`analyze_radar_chart`, `analyze_price_comparison`)
- 각 차트의 핵심 메트릭을 프롬프트에 명시
- AI에게 분석 요구사항을 구체적으로 제시

**Before:**
```python
# 범용 분석
context = "건강기능식품 제품 비교 분석"
return self.analyze_chart_data(chart_type, summary_data, context)
```

**After:**
```python
# 레이더 차트 전용 분석
if chart_type == "radar":
    return self.analyze_radar_chart(products_data)
elif chart_type == "bar" or chart_type == "price":
    return self.analyze_price_comparison(products_data)
```

---

## 업로드/배포 결과

### Git Commit 정보

```bash
Commit: ee628bb
Branch: main
Message: feat: Add specialized AI analysis for radar and price comparison charts
```

### 파일 변경 통계

```
1 file changed, 443 insertions(+), 45 deletions(-)
```

### Git Push 결과

```
To https://github.com/Siyeolryu/ica-github.git
   b2d9379..ee628bb  main -> main
```

### 검증 완료

```bash
# Python 구문 검증
python -m py_compile chart_analyzer.py
# ✅ 에러 없이 성공
```

---

## 배운 점

### 1. AI 에러 처리의 중요성

AI API는 항상 성공을 보장하지 않습니다. 네트워크 오류, API 키 문제, 모델 과부하 등 다양한 이유로 실패할 수 있습니다. 따라서 **항상 폴백 로직**을 구현하여 사용자에게 의미 있는 결과를 제공해야 합니다.

**Best Practice:**
- AI 호출을 try-except로 감싸기
- except 블록에서 데이터 기반 분석 수행
- 에러 메시지 대신 통계 요약 제공

### 2. 프롬프트 엔지니어링의 효과

AI에게 **구체적이고 구조화된 요구사항**을 제공할수록 더 정확하고 유용한 분석 결과를 얻을 수 있습니다.

**효과적인 프롬프트 구성:**
- 분석할 지표 명시 (1, 2, 3, ...)
- 기대하는 출력 형식 명시 (JSON 스키마)
- 분석 요구사항 구체화 ("강점/약점", "가성비 분석" 등)

### 3. 타입 안정성과 방어적 프로그래밍

다양한 데이터 소스에서 오는 정보를 처리할 때는 **타입과 존재 여부를 항상 검증**해야 합니다.

**안전한 코드 패턴:**
```python
# Bad
product_name = data["product"]["name"]

# Good
product = data.get("product", {})
product_name = product.get("name", "Unknown")
```

### 4. 차트별 특화 분석의 가치

범용 분석보다 **차트 타입에 최적화된 분석**이 훨씬 더 유용한 인사이트를 제공합니다. 사용자는 각 차트에서 얻고자 하는 정보가 다르기 때문입니다.

---

## 다음 단계

### 1. UI 통합 테스트

Streamlit 앱에서 실제로 AI 분석 버튼을 클릭했을 때 정상 동작하는지 확인:
- 레이더 차트 AI 분석 버튼 테스트
- 가격 비교 차트 AI 분석 버튼 테스트
- 에러 상황 시뮬레이션 (API 키 제거 등)

### 2. 추가 차트 타입 지원

현재 레이더 차트와 가격 비교 차트만 특화 분석을 제공합니다. 다음 차트도 고려:
- 게이지 차트 (신뢰도 점수 해석)
- 리뷰 감정 분석 차트
- 평점 분포 차트

### 3. 분석 결과 캐싱

동일한 데이터에 대해 반복적으로 AI 분석을 요청하는 것을 방지하기 위해 결과 캐싱 고려:
- Redis 또는 메모리 캐시 활용
- 데이터 해시값을 키로 사용
- TTL 설정 (예: 1시간)

### 4. 다국어 분석 지원

현재는 한국어 프롬프트와 응답만 지원합니다. 영어권 사용자를 위한 확장 고려:
- 프롬프트 템플릿 다국어화
- 사용자 언어 설정에 따라 프롬프트 선택

---

## 참고 자료

- [Anthropic API Documentation](https://docs.anthropic.com/)
- [Claude Sonnet 4.5 Model Guide](https://www.anthropic.com/claude)
- [Streamlit Chart Components](https://docs.streamlit.io/library/api-reference/charts)
- [Plotly Chart Types](https://plotly.com/python/)

---

**작성자**: Backend Developer Agent
**마지막 수정**: 2026-01-21
