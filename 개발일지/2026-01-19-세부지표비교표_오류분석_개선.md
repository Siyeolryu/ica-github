# 세부지표비교표 오류 분석 및 개선 방안

**작성일**: 2026-01-19
**작업자**: Claude
**작업 유형**: 버그 분석 / 코드 개선

---

## 1. 문제 개요

세부 지표 비교표(`render_comparison_table`) 및 관련 기능에서 KeyError, ValueError 등의 런타임 오류가 발생할 수 있는 취약점을 발견했습니다.

---

## 2. 발견된 오류 지점

### 2.1 visualizations.py - render_radar_chart (Line 35)

**현재 코드 (위험)**:
```python
for idx, data in enumerate(products_data):
    p, ai, r = data["product"], data["ai_result"], data["reviews"]
    vals = [
        ai['trust_score'],
        (sum(1 for x in r if x["reorder"]) / len(r) * 100) if r else 0,
        (sum(1 for x in r if x["one_month_use"]) / len(r) * 100) if r else 0,
        (sum(x["rating"] for x in r) / len(r) * 20) if r else 0,
        (len(set(x["reviewer"] for x in r)) / len(r) * 100) if r else 0
    ]
```

**문제점**:
- `data["product"]`, `data["ai_result"]`, `data["reviews"]` 직접 접근 → KeyError
- `ai['trust_score']` 직접 접근 → KeyError
- `x["reorder"]`, `x["one_month_use"]`, `x["rating"]`, `x["reviewer"]` 직접 접근 → KeyError

**수정 방안**:
```python
for idx, data in enumerate(products_data):
    p = data.get("product", {})
    ai = data.get("ai_result", {})
    r = data.get("reviews", [])

    trust_score = ai.get('trust_score', 0)
    reorder_rate = (sum(1 for x in r if x.get("reorder", False)) / len(r) * 100) if r else 0
    one_month_rate = (sum(1 for x in r if x.get("one_month_use", False)) / len(r) * 100) if r else 0
    avg_rating = (sum(x.get("rating", 0) for x in r) / len(r) * 20) if r else 0
    diversity_rate = (len(set(x.get("reviewer", "") for x in r)) / len(r) * 100) if r else 0

    vals = [trust_score, reorder_rate, one_month_rate, avg_rating, diversity_rate]
```

---

### 2.2 visualizations.py - render_price_comparison_chart (Line 58-60)

**현재 코드 (위험)**:
```python
names = [f"{d['product']['brand']}" for d in products_data]
prices = [d['product']['price'] for d in products_data]
scores = [d['ai_result']['trust_score'] for d in products_data]
```

**문제점**:
- 중첩 딕셔너리 직접 접근 → KeyError

**수정 방안**:
```python
names = []
prices = []
scores = []

for d in products_data:
    product = d.get('product', {})
    ai_result = d.get('ai_result', {})

    names.append(product.get('brand', 'Unknown'))
    prices.append(product.get('price', 0))
    scores.append(ai_result.get('trust_score', 0))
```

---

### 2.3 app.py - 정렬 로직 (Line 1387-1390)

**현재 코드 (위험)**:
```python
comparison_df["_sort_key"] = comparison_df[sort_column].apply(
    lambda x: float(str(x).replace("$", "").replace("개", "").replace("/5", "").replace("%", "").strip())
)
comparison_df = comparison_df.sort_values("_sort_key", ascending=ascending).drop(columns=["_sort_key"])
```

**문제점**:
1. `comparison_df[sort_column]` - 컬럼이 없으면 KeyError
2. `float(...)` 변환 - 잘못된 형식이면 ValueError
3. 빈 문자열이나 None 값 처리 부재

**수정 방안**:
```python
def safe_parse_value(x):
    """안전한 숫자 파싱"""
    try:
        if x is None or x == '':
            return 0.0
        cleaned = str(x).replace("$", "").replace("개", "").replace("/5", "").replace("%", "").replace("점", "").strip()
        return float(cleaned) if cleaned else 0.0
    except (ValueError, TypeError):
        return 0.0

# 컬럼 존재 확인 후 정렬
if sort_column in comparison_df.columns:
    comparison_df["_sort_key"] = comparison_df[sort_column].apply(safe_parse_value)
    comparison_df = comparison_df.sort_values("_sort_key", ascending=ascending).drop(columns=["_sort_key"])
else:
    st.warning(f"정렬 컬럼 '{sort_column}'을 찾을 수 없습니다.")
```

---

### 2.4 app.py - highlight_trust_row (Line 1393-1400)

**현재 코드 (위험)**:
```python
def highlight_trust_row(row):
    trust_val = float(str(row["신뢰도"]).replace("점", "").strip())
    if trust_val >= 70:
        return ['background-color: #dcfce7'] * len(row)
    elif trust_val >= 50:
        return ['background-color: #fef3c7'] * len(row)
    else:
        return ['background-color: #fee2e2'] * len(row)
```

**문제점**:
1. `row["신뢰도"]` 접근 - 컬럼이 없으면 KeyError
2. `float(...)` 변환 - 잘못된 값이면 ValueError

**수정 방안**:
```python
def highlight_trust_row(row):
    """신뢰도에 따른 행 하이라이트 (안전한 버전)"""
    try:
        trust_val = float(str(row.get("신뢰도", 0)).replace("점", "").replace("%", "").strip() or "0")
    except (ValueError, TypeError, AttributeError):
        trust_val = 0

    if trust_val >= 70:
        return ['background-color: #dcfce7'] * len(row)
    elif trust_val >= 50:
        return ['background-color: #fef3c7'] * len(row)
    else:
        return ['background-color: #fee2e2'] * len(row)
```

---

## 3. 데이터 형식 불일치 문제

### 3.1 신뢰도 컬럼 형식

**render_comparison_table (visualizations.py:109)**:
```python
"신뢰도": f"{ai_result.get('trust_score', 0):.1f}",  # 결과: "75.0"
```

**highlight_trust_row (app.py:1394)**:
```python
trust_val = float(str(row["신뢰도"]).replace("점", "").strip())  # "점" 제거 시도
```

**문제**: 신뢰도 값에 "점"이 없는데 "점"을 제거하려고 함 → 불필요한 처리

**해결**: 형식을 통일하거나, 파싱 로직에서 모든 가능한 형식 처리

---

## 4. 전체 개선 코드

### 4.1 visualizations.py 수정

```python
def render_radar_chart(products_data):
    """다차원 비교 레이더 차트 - 안전한 버전"""
    fig = go.Figure()
    categories = ['신뢰도', '재구매율', '한달사용', '평균평점', '리뷰다양성']
    colors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6']

    for idx, data in enumerate(products_data):
        p = data.get("product", {})
        ai = data.get("ai_result", {})
        r = data.get("reviews", [])

        # 안전한 값 계산
        trust_score = ai.get('trust_score', 0)
        reorder_rate = (sum(1 for x in r if x.get("reorder", False)) / len(r) * 100) if r else 0
        one_month_rate = (sum(1 for x in r if x.get("one_month_use", False)) / len(r) * 100) if r else 0
        avg_rating = (sum(x.get("rating", 0) for x in r) / len(r) * 20) if r else 0
        diversity_rate = (len(set(x.get("reviewer", "") for x in r)) / len(r) * 100) if r else 0

        vals = [trust_score, reorder_rate, one_month_rate, avg_rating, diversity_rate]

        fig.add_trace(go.Scatterpolar(
            r=vals,
            theta=categories,
            fill='toself',
            name=p.get('brand', 'Unknown'),
            line=dict(color=colors[idx % len(colors)], width=3)
        ))

    fig.update_layout(
        polar=dict(radialaxis=dict(visible=True, range=[0, 100])),
        height=550,
        legend=dict(orientation="h", y=-0.15, x=0.5, xanchor="center"),
        margin=dict(l=80, r=80, t=40, b=80),
        font=dict(size=14)
    )
    return fig


def render_price_comparison_chart(products_data):
    """가격 비교 차트 - 안전한 버전"""
    names = []
    prices = []
    scores = []

    for d in products_data:
        product = d.get('product', {})
        ai_result = d.get('ai_result', {})

        names.append(product.get('brand', 'Unknown'))
        prices.append(product.get('price', 0))
        scores.append(ai_result.get('trust_score', 0))

    colors = ['#22c55e' if s >= 70 else '#f59e0b' if s >= 50 else '#ef4444' for s in scores]

    fig = go.Figure(go.Bar(
        x=names,
        y=prices,
        marker_color=colors,
        text=[f"${p:.2f}" for p in prices],
        textposition='auto'
    ))
    fig.update_layout(title="제품별 가격 비교 (USD)", height=450, margin=dict(t=60, b=40))
    return fig
```

### 4.2 app.py 정렬 및 하이라이트 수정

```python
# 안전한 숫자 파싱 함수
def safe_parse_value(x):
    """안전한 숫자 파싱"""
    try:
        if x is None or x == '':
            return 0.0
        cleaned = str(x).replace("$", "").replace("개", "").replace("/5", "").replace("%", "").replace("점", "").strip()
        return float(cleaned) if cleaned else 0.0
    except (ValueError, TypeError):
        return 0.0

# 정렬 적용 (안전한 버전)
sort_map = {
    "신뢰도 높은순": ("신뢰도", False),
    "신뢰도 낮은순": ("신뢰도", True),
    "가격 낮은순": ("가격 ($)", True),
    "가격 높은순": ("가격 ($)", False),
    "리뷰 많은순": ("리뷰 수", False),
    "평점 높은순": ("평균 평점", False)
}
sort_column, ascending = sort_map.get(sort_by, ("신뢰도", False))

# 컬럼 존재 확인 후 정렬
if sort_column in comparison_df.columns:
    comparison_df["_sort_key"] = comparison_df[sort_column].apply(safe_parse_value)
    comparison_df = comparison_df.sort_values("_sort_key", ascending=ascending).drop(columns=["_sort_key"])

# 하이라이트 함수 (안전한 버전)
def highlight_trust_row(row):
    """신뢰도에 따른 행 하이라이트"""
    try:
        trust_val = safe_parse_value(row.get("신뢰도", 0))
    except:
        trust_val = 0

    if trust_val >= 70:
        return ['background-color: #dcfce7'] * len(row)
    elif trust_val >= 50:
        return ['background-color: #fef3c7'] * len(row)
    else:
        return ['background-color: #fee2e2'] * len(row)
```

---

## 5. 오류 요약 표

| 파일 | 라인 | 오류 유형 | 심각도 | 상태 |
|------|------|----------|--------|------|
| visualizations.py | 35 | KeyError (직접 인덱싱) | HIGH | ✅ 수정 완료 |
| visualizations.py | 38-42 | KeyError (중첩 접근) | HIGH | ✅ 수정 완료 |
| visualizations.py | 44 | KeyError (brand 접근) | MEDIUM | ✅ 수정 완료 |
| visualizations.py | 58-60 | KeyError (중첩 접근) | HIGH | ✅ 수정 완료 |
| app.py | 1387 | KeyError (컬럼 접근) | HIGH | ✅ 수정 완료 |
| app.py | 1388 | ValueError (float 변환) | HIGH | ✅ 수정 완료 |
| app.py | 1394 | KeyError + ValueError | HIGH | ✅ 수정 완료 |

---

## 6. 권장 수정 순서

### Phase 1: 즉시 수정 (HIGH)
1. `app.py:1387-1390` - 정렬 로직에 `safe_parse_value` 적용
2. `app.py:1393-1400` - `highlight_trust_row` 안전하게 수정
3. `visualizations.py:58-60` - 가격 비교 차트 안전한 접근

### Phase 2: 1주일 내 수정 (MEDIUM)
4. `visualizations.py:35-45` - 레이더 차트 전체 안전하게 수정
5. 공통 유틸리티 함수 추출 (`safe_parse_value`, `safe_get_nested`)

---

## 7. 테스트 케이스

```python
# 테스트: 빈 데이터 처리
def test_comparison_table_empty():
    result = render_comparison_table([])
    assert len(result) == 0

# 테스트: 부분 데이터 처리
def test_comparison_table_partial_data():
    partial_data = [{"product": {"brand": "Test"}}]  # ai_result, reviews 없음
    result = render_comparison_table(partial_data)
    assert len(result) == 1
    assert result.iloc[0]["제품명"] == "Test "

# 테스트: 정렬 오류 방지
def test_safe_parse_value():
    assert safe_parse_value("75.0") == 75.0
    assert safe_parse_value("$19.99") == 19.99
    assert safe_parse_value("20개") == 20.0
    assert safe_parse_value("4.5/5") == 4.5
    assert safe_parse_value("85%") == 85.0
    assert safe_parse_value(None) == 0.0
    assert safe_parse_value("") == 0.0
    assert safe_parse_value("invalid") == 0.0
```

---

## 8. 수정 완료 내역

- [x] Phase 1 수정 적용 ✅
- [x] Phase 2 수정 적용 ✅
- [x] 코드 검증 완료 ✅ (2026-01-19 최종 확인)
- [ ] 단위 테스트 작성 및 실행
- [ ] 통합 테스트 수행

### 최종 점검 결과 (2026-01-19)

**✅ 모든 수정 사항이 코드에 정상적으로 반영되었습니다:**

1. **utils.py**: `safe_parse_value()` 함수 구현 완료 (Line 265-295)
2. **visualizations.py**: 
   - `render_radar_chart()` 안전한 버전으로 수정 완료 (Line 28-64)
   - `render_price_comparison_chart()` 안전한 버전으로 수정 완료 (Line 66-90)
3. **app.py**:
   - `safe_parse_value` import 확인 완료 (Line 33)
   - 정렬 로직 안전하게 수정 완료 (Line 1387-1389)
   - `highlight_trust_row()` 안전한 버전으로 수정 완료 (Line 1392-1404)

**검증 방법:**
- `grep` 명령으로 모든 수정된 함수/변수 사용 위치 확인
- 각 파일의 실제 코드 내용 검토
- 개발일지의 수정 방안과 실제 코드 일치 여부 확인

### 수정된 파일 목록

| 파일 | 수정 내용 |
|------|----------|
| `ui_integration/utils.py` | `safe_parse_value()` 함수 추가 |
| `ui_integration/visualizations.py` | `render_radar_chart()` 안전한 버전으로 수정 |
| `ui_integration/visualizations.py` | `render_price_comparison_chart()` 안전한 버전으로 수정 |
| `ui_integration/app.py` | `safe_parse_value` import 추가 |
| `ui_integration/app.py` | 정렬 로직 안전하게 수정 |
| `ui_integration/app.py` | `highlight_trust_row()` 안전한 버전으로 수정 |

---

## 9. 참고

- 관련 파일: `ui_integration/app.py`, `ui_integration/visualizations.py`, `ui_integration/utils.py`
- 이전 분석: `개발일지/2026-01-19-UI_KeyError_점검.md`
